#!/bin/bash

#
# install the Tscript system
#   1. create directories to store the files generated by the install
#   2. download the ANTLR jar file (if necessary)
#   3. download the Javassist jar file (if necessary)
#   4. generate the scripts for compiling and running Tscript programs
#   5. build the system
#
# this script needs to be run from the directory where it is stored,
# which is tscript/bin
#
# you only need to run this script once
#
# use build.sh to re-build a system that is already installed
#

# create the directories to store the results of the build
#   deletes the old build directory first

cd ..
rm -rf build
mkdir build
cd build
mkdir bin lib packages

# download the ANTLR jar file unless it already exists
# in /usr/local/lib

cd lib
if [ -e /usr/local/lib/antlr-4.4-complete.jar ]
then
  ln -s /usr/local/lib/antlr-4.4-complete.jar antlr.jar
else
  curl --silent -L http://www.antlr.org/download/antlr-4.4-complete.jar >antlr.jar
fi
cd ..

# download the Javassist jar file unless it already exists
# in /usr/local/lib

cd lib
if [ -e /usr/local/lib/javassist.jar ]
then
  ln -s /usr/local/lib/javassist.jar javassist.jar
else
  curl --silent -L https://github.com/jboss-javassist/javassist/releases/download/rel_3_19_0_ga/javassist.jar >javassist.jar
fi
cd ..

# create ts script
cd ..
cat scripts/ts.start >build/bin/ts
echo TS_ROOT=\"`pwd`\" >>build/bin/ts
cat scripts/ts.end >>build/bin/ts
chmod u+x build/bin/ts

# create tsdb script
cat scripts/tsdb.start >build/bin/tsdb
echo TS_ROOT=\"`pwd`\" >>build/bin/tsdb
cat scripts/tsdb.end >>build/bin/tsdb
chmod u+x build/bin/tsdb

# create jc script
cat scripts/jc.start >build/bin/jc
echo TS_ROOT=\"`pwd`\" >>build/bin/jc
cat scripts/jc.end >>build/bin/jc
chmod u+x build/bin/jc

# create j script
cat scripts/j.start >build/bin/j
echo TS_ROOT=\"`pwd`\" >>build/bin/j
cat scripts/j.end >>build/bin/j
chmod u+x build/bin/j

# create jdebug script
cat scripts/jdebug.start >build/bin/jdebug
echo TS_ROOT=\"`pwd`\" >>build/bin/jdebug
cat scripts/jdebug.end >>build/bin/jdebug
chmod u+x build/bin/jdebug

# clean out any old ANTLR-generated files
pushd src/ts/parse >&/dev/null
make -silent clean
popd >&/dev/null

# build the system
cd bin
bash build.sh


